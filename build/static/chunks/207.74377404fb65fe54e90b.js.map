{"version":3,"sources":["webpack://_N_E/./node_modules/next/node_modules/@babel/runtime/helpers/esm/initializerDefineProperty.js","webpack://_N_E/./node_modules/next/node_modules/@babel/runtime/helpers/esm/applyDecoratedDescriptor.js","webpack://_N_E/./modules/message/helpers/messageOf.ts","webpack://_N_E/./node_modules/idb/build/esm/wrap-idb-value.js","webpack://_N_E/./node_modules/idb/build/esm/index.js","webpack://_N_E/./modules/database/connection/showUpgradeBlockedMessage.ts","webpack://_N_E/./common/object/mapKeys.ts","webpack://_N_E/./common/object/toSnakeCase.ts","webpack://_N_E/./modules/database/connection/upgradeDatabase.ts","webpack://_N_E/./modules/database/connection/openDatabase.ts","webpack://_N_E/./modules/database/DatabaseManager.ts","webpack://_N_E/./modules/database/DatabaseManagerContext.ts","webpack://_N_E/./modules/database/persist/PushNotificationModal.tsx","webpack://_N_E/./modules/database/persist/PersistentStorageWarning.tsx","webpack://_N_E/./common/dom/downloadBlob.ts","webpack://_N_E/./modules/database/backup/BackupManager.ts","webpack://_N_E/./modules/database/backup/BackupManagerContext.ts","webpack://_N_E/./modules/database/backup/modal/BackupCreationControls.tsx","webpack://_N_E/./icons/save.tsx","webpack://_N_E/./icons/trash.tsx","webpack://_N_E/./icons/upload.tsx","webpack://_N_E/./modules/database/backup/modal/DeletionConfirmationModal.tsx","webpack://_N_E/./modules/database/backup/modal/BackupItem.tsx","webpack://_N_E/./modules/database/backup/modal/BackupList.tsx","webpack://_N_E/./modules/database/backup/modal/BackupsModal.tsx"],"names":["_initializerDefineProperty","target","property","descriptor","context","Object","defineProperty","enumerable","configurable","writable","value","initializer","call","_applyDecoratedDescriptor","decorators","desc","keys","forEach","key","slice","reverse","reduce","decorator","undefined","messageOf","data","snapshot","content","username","avatar","avatar_url","embeds","embedData","embed","length","url","gallery","image","push","title","description","author","name","authorUrl","authorIcon","icon_url","footer","text","footerIcon","timestamp","Date","Number","NaN","filter","Boolean","thumbnail","color","ColorModel","create","setRaw","fields","fieldData","field","inline","idbProxyableTypes","cursorAdvanceMethods","cursorRequestMap","WeakMap","transactionDoneMap","transactionStoreNamesMap","transformCache","reverseTransformCache","idbProxyTraps","prop","receiver","IDBTransaction","get","objectStoreNames","objectStore","wrap","set","has","wrapFunction","func","IDBDatabase","prototype","transaction","IDBCursor","advance","continue","continuePrimaryKey","includes","args","apply","unwrap","this","storeNames","tx","sort","transformCachableValue","done","Promise","resolve","reject","unlisten","removeEventListener","complete","error","DOMException","addEventListener","cacheDonePromiseForTransaction","object","IDBObjectStore","IDBIndex","some","c","Proxy","IDBRequest","request","promise","success","result","then","catch","promisifyRequest","newValue","readMethods","writeMethods","cachedMethods","Map","getMethod","targetFuncName","replace","useIndex","isWrite","method","async","storeName","store","index","shift","all","oldTraps","callback","showUpgradeBlockedMessage","container","document","createElement","id","style","position","top","right","bottom","left","background","padding","header","append","blockedMessage","closeTabsMessage","body","isObject","mapKeys","fn","Array","isArray","map","entries","toSnakeCase","match","toLowerCase","openDatabase","version","blocked","upgrade","blocking","terminated","indexedDB","open","openPromise","event","oldVersion","newVersion","db","openDB","database","cursor","openCursor","update","message","createObjectStore","keyPath","autoIncrement","createIndex","unique","backupStore","existingBackups","Set","nameCursor","openKeyCursor","add","put","rest","messages","webhookUrl","reference","delete","backup","targets","upgradeDatabase","localStorage","setItem","querySelector","remove","console","DatabaseManager","constructor","markAsInitialized","initialized","navigator","storage","persisted","window","Notification","requestPermission","persist","persistenceMessageDismissed","observable","computed","DatabaseManagerContext","createContext","displayName","DatabaseManagerProvider","Provider","PushNotificationModal","props","databaseManager","modal","useRequiredContext","ModalContext","ModalContainer","ModalHeader","ModalTitle","ModalAction","icon","label","onClick","dismiss","ModalBody","Markdown","ModalFooter","SecondaryButton","PrimaryButton","requestPersistence","Container","styled","div","theme","secondary","Header","h5","primary","Buttons","ButtonRow","PersistentStorageWarning","modalManager","ModalManagerContext","useObserver","spawn","render","downloadBlob","blob","URL","createObjectURL","anchor","href","download","click","revokeObjectURL","BackupManager","editorManager","loadBackupList","backups","primaryKey","runInAction","getKey","fetch","getId","files","backupData","Blob","JSON","stringify","type","number","proposedName","exportData","parse","saveBackup","getSafeBackupName","BackupManagerContext","BackupManagerProvider","BackupCreationControls","backupManager","backupName","setBackupName","useState","InputField","onChange","disabled","trim","save","width","height","viewBox","fill","d","stroke","strokeWidth","strokeLinecap","strokeLinejoin","trash","upload","DeletionConfirmationModal","deleteBackup","li","backgroundModifier","accent","Button","BackupName","ellipsis","BackupItem","ActionButtons","actions","handler","loadBackup","exportBackup","overflow","copy","ul","BackupList","search","setSearch","toLocaleLowerCase","BackupsModal","useLazyValue","fileInputRef","useRef","ref","display","file","item","importBackups","shouldShowPersistenceWarning","exportAll","current"],"mappings":"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","file":"static/chunks/207.74377404fb65fe54e90b.js","sourcesContent":["export default function _initializerDefineProperty(target, property, descriptor, context) {\n  if (!descriptor) return;\n  Object.defineProperty(target, property, {\n    enumerable: descriptor.enumerable,\n    configurable: descriptor.configurable,\n    writable: descriptor.writable,\n    value: descriptor.initializer ? descriptor.initializer.call(context) : void 0\n  });\n}","export default function _applyDecoratedDescriptor(target, property, decorators, descriptor, context) {\n  var desc = {};\n  Object.keys(descriptor).forEach(function (key) {\n    desc[key] = descriptor[key];\n  });\n  desc.enumerable = !!desc.enumerable;\n  desc.configurable = !!desc.configurable;\n\n  if ('value' in desc || desc.initializer) {\n    desc.writable = true;\n  }\n\n  desc = decorators.slice().reverse().reduce(function (desc, decorator) {\n    return decorator(target, property, desc) || desc;\n  }, desc);\n\n  if (context && desc.initializer !== void 0) {\n    desc.value = desc.initializer ? desc.initializer.call(context) : void 0;\n    desc.initializer = undefined;\n  }\n\n  if (desc.initializer === void 0) {\n    Object.defineProperty(target, property, desc);\n    desc = null;\n  }\n\n  return desc;\n}","import type { SnapshotIn } from \"mobx-state-tree\"\r\nimport { ColorModel } from \"../../../common/input/color/ColorModel\"\r\nimport type { MessageData } from \"../state/data/MessageData\"\r\nimport type { MessageModel } from \"../state/models/MessageModel\"\r\n\r\nexport const messageOf = (data: MessageData) => {\r\n  const snapshot: Record<string, unknown> = {}\r\n\r\n  snapshot.content = data.content ?? \"\"\r\n  snapshot.username = data.username ?? \"\"\r\n  snapshot.avatar = data.avatar_url ?? \"\"\r\n\r\n  const embeds: Record<string, unknown>[] = []\r\n  snapshot.embeds = embeds\r\n\r\n  for (const embedData of data.embeds ?? []) {\r\n    let embed = embeds.length > 0 ? embeds[embeds.length - 1] : undefined\r\n\r\n    if (embed?.url && embed.url === embedData.url) {\r\n      const gallery = embed.gallery as string[]\r\n      if (embedData.image?.url && gallery.length < 4) {\r\n        gallery.push(embedData.image.url)\r\n      }\r\n\r\n      continue\r\n    }\r\n\r\n    embed = {}\r\n    embeds.push(embed)\r\n\r\n    embed.title = embedData.title ?? \"\"\r\n    embed.description = embedData.description ?? \"\"\r\n    embed.url = embedData.url ?? \"\"\r\n    embed.author = embedData.author?.name ?? \"\"\r\n    embed.authorUrl = embedData.author?.url ?? \"\"\r\n    embed.authorIcon = embedData.author?.icon_url ?? \"\"\r\n    embed.footer = embedData.footer?.text ?? \"\"\r\n    embed.footerIcon = embedData.footer?.icon_url ?? \"\"\r\n    embed.timestamp = new Date(embedData.timestamp ?? Number.NaN)\r\n    embed.gallery = [embedData.image?.url ?? \"\"].filter(Boolean)\r\n    embed.thumbnail = embedData.thumbnail?.url ?? \"\"\r\n\r\n    const color = ColorModel.create()\r\n    color.setRaw(embedData.color ?? null)\r\n    embed.color = color\r\n\r\n    const fields: Record<string, unknown>[] = []\r\n    embed.fields = fields\r\n\r\n    for (const fieldData of embedData.fields ?? []) {\r\n      const field: Record<string, unknown> = {}\r\n      fields.push(field)\r\n\r\n      field.name = fieldData.name ?? \"\"\r\n      field.value = fieldData.value ?? \"\"\r\n      field.inline = fieldData.inline ?? false\r\n    }\r\n  }\r\n\r\n  return snapshot as SnapshotIn<typeof MessageModel>\r\n}\r\n","const instanceOfAny = (object, constructors) => constructors.some((c) => object instanceof c);\n\nlet idbProxyableTypes;\nlet cursorAdvanceMethods;\n// This is a function to prevent it throwing up in node environments.\nfunction getIdbProxyableTypes() {\n    return (idbProxyableTypes ||\n        (idbProxyableTypes = [\n            IDBDatabase,\n            IDBObjectStore,\n            IDBIndex,\n            IDBCursor,\n            IDBTransaction,\n        ]));\n}\n// This is a function to prevent it throwing up in node environments.\nfunction getCursorAdvanceMethods() {\n    return (cursorAdvanceMethods ||\n        (cursorAdvanceMethods = [\n            IDBCursor.prototype.advance,\n            IDBCursor.prototype.continue,\n            IDBCursor.prototype.continuePrimaryKey,\n        ]));\n}\nconst cursorRequestMap = new WeakMap();\nconst transactionDoneMap = new WeakMap();\nconst transactionStoreNamesMap = new WeakMap();\nconst transformCache = new WeakMap();\nconst reverseTransformCache = new WeakMap();\nfunction promisifyRequest(request) {\n    const promise = new Promise((resolve, reject) => {\n        const unlisten = () => {\n            request.removeEventListener('success', success);\n            request.removeEventListener('error', error);\n        };\n        const success = () => {\n            resolve(wrap(request.result));\n            unlisten();\n        };\n        const error = () => {\n            reject(request.error);\n            unlisten();\n        };\n        request.addEventListener('success', success);\n        request.addEventListener('error', error);\n    });\n    promise\n        .then((value) => {\n        // Since cursoring reuses the IDBRequest (*sigh*), we cache it for later retrieval\n        // (see wrapFunction).\n        if (value instanceof IDBCursor) {\n            cursorRequestMap.set(value, request);\n        }\n        // Catching to avoid \"Uncaught Promise exceptions\"\n    })\n        .catch(() => { });\n    // This mapping exists in reverseTransformCache but doesn't doesn't exist in transformCache. This\n    // is because we create many promises from a single IDBRequest.\n    reverseTransformCache.set(promise, request);\n    return promise;\n}\nfunction cacheDonePromiseForTransaction(tx) {\n    // Early bail if we've already created a done promise for this transaction.\n    if (transactionDoneMap.has(tx))\n        return;\n    const done = new Promise((resolve, reject) => {\n        const unlisten = () => {\n            tx.removeEventListener('complete', complete);\n            tx.removeEventListener('error', error);\n            tx.removeEventListener('abort', error);\n        };\n        const complete = () => {\n            resolve();\n            unlisten();\n        };\n        const error = () => {\n            reject(tx.error || new DOMException('AbortError', 'AbortError'));\n            unlisten();\n        };\n        tx.addEventListener('complete', complete);\n        tx.addEventListener('error', error);\n        tx.addEventListener('abort', error);\n    });\n    // Cache it for later retrieval.\n    transactionDoneMap.set(tx, done);\n}\nlet idbProxyTraps = {\n    get(target, prop, receiver) {\n        if (target instanceof IDBTransaction) {\n            // Special handling for transaction.done.\n            if (prop === 'done')\n                return transactionDoneMap.get(target);\n            // Polyfill for objectStoreNames because of Edge.\n            if (prop === 'objectStoreNames') {\n                return target.objectStoreNames || transactionStoreNamesMap.get(target);\n            }\n            // Make tx.store return the only store in the transaction, or undefined if there are many.\n            if (prop === 'store') {\n                return receiver.objectStoreNames[1]\n                    ? undefined\n                    : receiver.objectStore(receiver.objectStoreNames[0]);\n            }\n        }\n        // Else transform whatever we get back.\n        return wrap(target[prop]);\n    },\n    set(target, prop, value) {\n        target[prop] = value;\n        return true;\n    },\n    has(target, prop) {\n        if (target instanceof IDBTransaction &&\n            (prop === 'done' || prop === 'store')) {\n            return true;\n        }\n        return prop in target;\n    },\n};\nfunction replaceTraps(callback) {\n    idbProxyTraps = callback(idbProxyTraps);\n}\nfunction wrapFunction(func) {\n    // Due to expected object equality (which is enforced by the caching in `wrap`), we\n    // only create one new func per func.\n    // Edge doesn't support objectStoreNames (booo), so we polyfill it here.\n    if (func === IDBDatabase.prototype.transaction &&\n        !('objectStoreNames' in IDBTransaction.prototype)) {\n        return function (storeNames, ...args) {\n            const tx = func.call(unwrap(this), storeNames, ...args);\n            transactionStoreNamesMap.set(tx, storeNames.sort ? storeNames.sort() : [storeNames]);\n            return wrap(tx);\n        };\n    }\n    // Cursor methods are special, as the behaviour is a little more different to standard IDB. In\n    // IDB, you advance the cursor and wait for a new 'success' on the IDBRequest that gave you the\n    // cursor. It's kinda like a promise that can resolve with many values. That doesn't make sense\n    // with real promises, so each advance methods returns a new promise for the cursor object, or\n    // undefined if the end of the cursor has been reached.\n    if (getCursorAdvanceMethods().includes(func)) {\n        return function (...args) {\n            // Calling the original function with the proxy as 'this' causes ILLEGAL INVOCATION, so we use\n            // the original object.\n            func.apply(unwrap(this), args);\n            return wrap(cursorRequestMap.get(this));\n        };\n    }\n    return function (...args) {\n        // Calling the original function with the proxy as 'this' causes ILLEGAL INVOCATION, so we use\n        // the original object.\n        return wrap(func.apply(unwrap(this), args));\n    };\n}\nfunction transformCachableValue(value) {\n    if (typeof value === 'function')\n        return wrapFunction(value);\n    // This doesn't return, it just creates a 'done' promise for the transaction,\n    // which is later returned for transaction.done (see idbObjectHandler).\n    if (value instanceof IDBTransaction)\n        cacheDonePromiseForTransaction(value);\n    if (instanceOfAny(value, getIdbProxyableTypes()))\n        return new Proxy(value, idbProxyTraps);\n    // Return the same value back if we're not going to transform it.\n    return value;\n}\nfunction wrap(value) {\n    // We sometimes generate multiple promises from a single IDBRequest (eg when cursoring), because\n    // IDB is weird and a single IDBRequest can yield many responses, so these can't be cached.\n    if (value instanceof IDBRequest)\n        return promisifyRequest(value);\n    // If we've already transformed this value before, reuse the transformed value.\n    // This is faster, but it also provides object equality.\n    if (transformCache.has(value))\n        return transformCache.get(value);\n    const newValue = transformCachableValue(value);\n    // Not all types are transformed.\n    // These may be primitive types, so they can't be WeakMap keys.\n    if (newValue !== value) {\n        transformCache.set(value, newValue);\n        reverseTransformCache.set(newValue, value);\n    }\n    return newValue;\n}\nconst unwrap = (value) => reverseTransformCache.get(value);\n\nexport { reverseTransformCache as a, instanceOfAny as i, replaceTraps as r, unwrap as u, wrap as w };\n","import { w as wrap, r as replaceTraps } from './wrap-idb-value.js';\nexport { u as unwrap, w as wrap } from './wrap-idb-value.js';\n\n/**\n * Open a database.\n *\n * @param name Name of the database.\n * @param version Schema version.\n * @param callbacks Additional callbacks.\n */\nfunction openDB(name, version, { blocked, upgrade, blocking, terminated } = {}) {\n    const request = indexedDB.open(name, version);\n    const openPromise = wrap(request);\n    if (upgrade) {\n        request.addEventListener('upgradeneeded', (event) => {\n            upgrade(wrap(request.result), event.oldVersion, event.newVersion, wrap(request.transaction));\n        });\n    }\n    if (blocked)\n        request.addEventListener('blocked', () => blocked());\n    openPromise\n        .then((db) => {\n        if (terminated)\n            db.addEventListener('close', () => terminated());\n        if (blocking)\n            db.addEventListener('versionchange', () => blocking());\n    })\n        .catch(() => { });\n    return openPromise;\n}\n/**\n * Delete a database.\n *\n * @param name Name of the database.\n */\nfunction deleteDB(name, { blocked } = {}) {\n    const request = indexedDB.deleteDatabase(name);\n    if (blocked)\n        request.addEventListener('blocked', () => blocked());\n    return wrap(request).then(() => undefined);\n}\n\nconst readMethods = ['get', 'getKey', 'getAll', 'getAllKeys', 'count'];\nconst writeMethods = ['put', 'add', 'delete', 'clear'];\nconst cachedMethods = new Map();\nfunction getMethod(target, prop) {\n    if (!(target instanceof IDBDatabase &&\n        !(prop in target) &&\n        typeof prop === 'string')) {\n        return;\n    }\n    if (cachedMethods.get(prop))\n        return cachedMethods.get(prop);\n    const targetFuncName = prop.replace(/FromIndex$/, '');\n    const useIndex = prop !== targetFuncName;\n    const isWrite = writeMethods.includes(targetFuncName);\n    if (\n    // Bail if the target doesn't exist on the target. Eg, getAll isn't in Edge.\n    !(targetFuncName in (useIndex ? IDBIndex : IDBObjectStore).prototype) ||\n        !(isWrite || readMethods.includes(targetFuncName))) {\n        return;\n    }\n    const method = async function (storeName, ...args) {\n        // isWrite ? 'readwrite' : undefined gzipps better, but fails in Edge :(\n        const tx = this.transaction(storeName, isWrite ? 'readwrite' : 'readonly');\n        let target = tx.store;\n        if (useIndex)\n            target = target.index(args.shift());\n        // Must reject if op rejects.\n        // If it's a write operation, must reject if tx.done rejects.\n        // Must reject with op rejection first.\n        // Must resolve with op value.\n        // Must handle both promises (no unhandled rejections)\n        return (await Promise.all([\n            target[targetFuncName](...args),\n            isWrite && tx.done,\n        ]))[0];\n    };\n    cachedMethods.set(prop, method);\n    return method;\n}\nreplaceTraps((oldTraps) => ({\n    ...oldTraps,\n    get: (target, prop, receiver) => getMethod(target, prop) || oldTraps.get(target, prop, receiver),\n    has: (target, prop) => !!getMethod(target, prop) || oldTraps.has(target, prop),\n}));\n\nexport { deleteDB, openDB };\n","export const showUpgradeBlockedMessage = () => {\r\n  const container = document.createElement(\"div\")\r\n  container.id = \"db-upgrade-blocked\"\r\n  container.style.position = \"absolute\"\r\n  container.style.top = \"0\"\r\n  container.style.right = \"0\"\r\n  container.style.bottom = \"0\"\r\n  container.style.left = \"0\"\r\n  container.style.background = \"rgba(0, 0, 0, 0.85)\"\r\n  container.style.padding = \"16px\"\r\n\r\n  const header = document.createElement(\"h1\")\r\n  header.style.color = \"#ffffff\"\r\n  header.append(\"Discohook's local database needs an upgrade\")\r\n\r\n  const blockedMessage = document.createElement(\"p\")\r\n  blockedMessage.append(\r\n    \"However, the upgrade can't proceed because there are older sessions of Discohook open.\",\r\n  )\r\n\r\n  const closeTabsMessage = document.createElement(\"p\")\r\n  closeTabsMessage.append(\"Please close all Discohook tabs before continuing.\")\r\n\r\n  container.append(header, blockedMessage, closeTabsMessage)\r\n  document.body.append(container)\r\n}\r\n","const isObject = (value: unknown) => typeof value === \"object\" && value !== null\r\n\r\nexport const mapKeys = (\r\n  object: unknown,\r\n  fn: (key: string) => string,\r\n): Record<string, unknown> | unknown[] => {\r\n  if (Array.isArray(object)) {\r\n    return object.map(value => (isObject(value) ? mapKeys(value, fn) : value))\r\n  }\r\n\r\n  const result: Record<string, unknown> = {}\r\n\r\n  for (const [key, value] of Object.entries(\r\n    object as Record<string, unknown>,\r\n  )) {\r\n    if (isObject(value)) {\r\n      result[fn(key)] = mapKeys(value, fn)\r\n    } else {\r\n      result[fn(key)] = value\r\n    }\r\n  }\r\n\r\n  return result\r\n}\r\n","import { mapKeys } from \"./mapKeys\"\r\n\r\nexport const toSnakeCase = (object: unknown) =>\r\n  mapKeys(object, key =>\r\n    key.replace(/[A-Z]/g, match => `_${match.toLowerCase()}`),\r\n  )\r\n","/* eslint-disable no-await-in-loop */\r\n\r\nimport type { IDBPDatabase, IDBPTransaction } from \"idb\"\r\nimport { toSnakeCase } from \"../../../common/object/toSnakeCase\"\r\n\r\nexport const upgradeDatabase = async (\r\n  database: IDBPDatabase,\r\n  transaction: IDBPTransaction<unknown, string[], \"versionchange\">,\r\n  oldVersion: number,\r\n) => {\r\n  if (oldVersion < 2 && oldVersion >= 1) {\r\n    let cursor = await transaction.objectStore(\"backups\").openCursor()\r\n\r\n    while (cursor) {\r\n      await cursor.update({\r\n        name: cursor.key,\r\n        message: cursor.value,\r\n      })\r\n\r\n      cursor = await cursor.continue()\r\n    }\r\n  }\r\n\r\n  if (oldVersion < 3) {\r\n    database.createObjectStore(\"backup\", {\r\n      keyPath: \"id\",\r\n      autoIncrement: true,\r\n    })\r\n\r\n    const backupStore = transaction.objectStore(\"backup\")\r\n    backupStore.createIndex(\"name\", \"name\", {\r\n      unique: true,\r\n    })\r\n  }\r\n\r\n  if (oldVersion < 4 && oldVersion >= 1) {\r\n    const backupStore = transaction.objectStore(\"backup\")\r\n\r\n    const existingBackups = new Set<IDBValidKey>()\r\n    let nameCursor = await backupStore.index(\"name\").openKeyCursor()\r\n\r\n    while (nameCursor) {\r\n      existingBackups.add(nameCursor.key)\r\n      nameCursor = await nameCursor.continue()\r\n    }\r\n\r\n    let cursor = await transaction.objectStore(\"backups\").openCursor()\r\n\r\n    while (cursor) {\r\n      if (!existingBackups.has(cursor.key)) {\r\n        await backupStore.put({\r\n          ...cursor.value,\r\n          name: cursor.key,\r\n          message: toSnakeCase(cursor.value.message),\r\n        })\r\n      }\r\n\r\n      cursor = await cursor.continue()\r\n    }\r\n  }\r\n\r\n  if (oldVersion < 5 && oldVersion >= 1) {\r\n    const backupStore = transaction.objectStore(\"backup\")\r\n\r\n    let cursor = await backupStore.openCursor()\r\n\r\n    while (cursor) {\r\n      const { message, ...rest } = cursor.value\r\n\r\n      await backupStore.put({\r\n        ...rest,\r\n        messages: [message],\r\n      })\r\n\r\n      cursor = await cursor.continue()\r\n    }\r\n  }\r\n\r\n  if (oldVersion < 6 && oldVersion >= 1) {\r\n    const backupStore = transaction.objectStore(\"backup\")\r\n\r\n    let cursor = await backupStore.openCursor()\r\n\r\n    while (cursor) {\r\n      const { webhookUrl, ...rest } = cursor.value\r\n\r\n      await backupStore.put({\r\n        ...rest,\r\n        target: {\r\n          url: webhookUrl,\r\n        },\r\n      })\r\n\r\n      cursor = await cursor.continue()\r\n    }\r\n  }\r\n\r\n  if (oldVersion < 9 && oldVersion >= 1) {\r\n    const backupStore = transaction.objectStore(\"backup\")\r\n\r\n    let cursor = await backupStore.openCursor()\r\n\r\n    while (cursor) {\r\n      const { id, name, messages, target } = cursor.value\r\n\r\n      if (name) {\r\n        await backupStore.put({\r\n          id,\r\n          name,\r\n          messages: messages.map((data: Record<string, unknown>) => ({\r\n            data: \"data\" in data ? data.data : data,\r\n            reference: \"reference\" in data ? data.reference : target.message,\r\n          })),\r\n          target: {\r\n            url: target.url,\r\n          },\r\n        })\r\n      } else {\r\n        await backupStore.delete(id)\r\n      }\r\n\r\n      cursor = await cursor.continue()\r\n    }\r\n  }\r\n\r\n  if (oldVersion < 10 && oldVersion >= 1) {\r\n    const backupStore = transaction.objectStore(\"backup\")\r\n\r\n    let cursor = await backupStore.openCursor()\r\n\r\n    while (cursor) {\r\n      const { target, ...backup } = cursor.value\r\n\r\n      await backupStore.put({\r\n        ...backup,\r\n        targets: [{ url: target.url ?? \"\" }],\r\n      })\r\n\r\n      cursor = await cursor.continue()\r\n    }\r\n  }\r\n}\r\n","import { IDBPDatabase, IDBPTransaction, openDB } from \"idb\"\r\nimport type { Schema } from \"../Schema\"\r\nimport { showUpgradeBlockedMessage } from \"./showUpgradeBlockedMessage\"\r\nimport { upgradeDatabase } from \"./upgradeDatabase\"\r\n\r\nexport const openDatabase = async () => {\r\n  return openDB<Schema>(\"discohook\", 10, {\r\n    upgrade: (database, oldVersion, newVersion, transaction) => {\r\n      // Casting to unknown schema, because upgrades shouldn't assume how the\r\n      // schema looks at that time\r\n      upgradeDatabase(\r\n        database as IDBPDatabase,\r\n        transaction as IDBPTransaction<unknown, string[], \"versionchange\">,\r\n        oldVersion,\r\n      )\r\n        .then(() => {\r\n          localStorage.setItem(\"database-upgraded-version\", \"10\")\r\n          document.querySelector(\"#db-upgrade-blocked\")?.remove()\r\n        })\r\n        .catch(error => {\r\n          console.error(\"Error on database upgrade:\", error)\r\n        })\r\n    },\r\n    blocked: showUpgradeBlockedMessage,\r\n  })\r\n}\r\n","import type { IDBPDatabase } from \"idb\"\r\nimport { computed, observable } from \"mobx\"\r\nimport { openDatabase } from \"./connection/openDatabase\"\r\nimport type { Schema } from \"./Schema\"\r\n\r\nexport class DatabaseManager {\r\n  initialized: Promise<void>\r\n  database!: IDBPDatabase<Schema>\r\n\r\n  @observable persisted = true\r\n  @observable persistenceMessageDismissed = false\r\n\r\n  constructor() {\r\n    let markAsInitialized: () => void\r\n    this.initialized = new Promise(resolve => {\r\n      markAsInitialized = resolve\r\n    })\r\n\r\n    if (typeof window === \"undefined\") return\r\n\r\n    if (\"storage\" in navigator) {\r\n      navigator.storage\r\n        .persisted()\r\n        .then(persisted => {\r\n          this.persisted = persisted\r\n        })\r\n        .catch(() => {})\r\n    }\r\n\r\n    openDatabase()\r\n      .then(database => {\r\n        this.database = database\r\n        markAsInitialized()\r\n      })\r\n      .catch(error => {\r\n        console.error(\"Failed to open database:\", error)\r\n      })\r\n  }\r\n\r\n  async requestPersistence() {\r\n    if (\"chrome\" in window) {\r\n      await Notification.requestPermission()\r\n    }\r\n\r\n    if (\"storage\" in navigator) {\r\n      this.persisted = await navigator.storage.persist()\r\n    }\r\n  }\r\n\r\n  @computed get shouldShowPersistenceWarning() {\r\n    return !this.persisted && !this.persistenceMessageDismissed\r\n  }\r\n}\r\n","import { createContext } from \"react\"\r\nimport type { DatabaseManager } from \"./DatabaseManager\"\r\n\r\nexport const DatabaseManagerContext = createContext<DatabaseManager | null>(\r\n  null,\r\n)\r\n\r\nDatabaseManagerContext.displayName = \"DatabaseManagerContext\"\r\n\r\nexport const DatabaseManagerProvider = DatabaseManagerContext.Provider\r\n","import React from \"react\"\r\nimport { PrimaryButton } from \"../../../common/input/button/PrimaryButton\"\r\nimport { SecondaryButton } from \"../../../common/input/button/SecondaryButton\"\r\nimport { ModalAction } from \"../../../common/modal/layout/ModalAction\"\r\nimport { ModalBody } from \"../../../common/modal/layout/ModalBody\"\r\nimport { ModalContainer } from \"../../../common/modal/layout/ModalContainer\"\r\nimport { ModalFooter } from \"../../../common/modal/layout/ModalFooter\"\r\nimport { ModalHeader } from \"../../../common/modal/layout/ModalHeader\"\r\nimport { ModalTitle } from \"../../../common/modal/layout/ModalTitle\"\r\nimport { ModalContext } from \"../../../common/modal/ModalContext\"\r\nimport { useRequiredContext } from \"../../../common/state/useRequiredContext\"\r\nimport { remove } from \"../../../icons/remove\"\r\nimport { Markdown } from \"../../markdown/Markdown\"\r\nimport type { DatabaseManager } from \"../DatabaseManager\"\r\n\r\nexport type PushNotificationModalProps = {\r\n  databaseManager: DatabaseManager\r\n}\r\n\r\nexport function PushNotificationModal(props: PushNotificationModalProps) {\r\n  const { databaseManager } = props\r\n\r\n  const modal = useRequiredContext(ModalContext)\r\n\r\n  return (\r\n    <ModalContainer>\r\n      <ModalHeader>\r\n        <ModalTitle>Notice</ModalTitle>\r\n        <ModalAction\r\n          icon={remove}\r\n          label=\"Close\"\r\n          onClick={() => modal.dismiss()}\r\n        />\r\n      </ModalHeader>\r\n      <ModalBody>\r\n        <Markdown\r\n          content={\r\n            \"Chrome based browsers do not allow manual control of persistent\" +\r\n            \" storage. As a workaround, you can grant this site permission to\" +\r\n            \" send notifications to allow the site to use persistent storage.\"\r\n          }\r\n        />\r\n      </ModalBody>\r\n      <ModalFooter>\r\n        <SecondaryButton onClick={() => modal.dismiss()}>\r\n          Cancel\r\n        </SecondaryButton>\r\n        <PrimaryButton\r\n          onClick={async () => {\r\n            modal.dismiss()\r\n            await databaseManager.requestPersistence()\r\n          }}\r\n        >\r\n          Request permission\r\n        </PrimaryButton>\r\n      </ModalFooter>\r\n    </ModalContainer>\r\n  )\r\n}\r\n","import { useObserver } from \"mobx-react-lite\"\r\nimport React from \"react\"\r\nimport styled from \"styled-components\"\r\nimport { PrimaryButton } from \"../../../common/input/button/PrimaryButton\"\r\nimport { SecondaryButton } from \"../../../common/input/button/SecondaryButton\"\r\nimport { ButtonRow } from \"../../../common/layout/ButtonRow\"\r\nimport { ModalManagerContext } from \"../../../common/modal/ModalManagerContext\"\r\nimport { useRequiredContext } from \"../../../common/state/useRequiredContext\"\r\nimport { Markdown } from \"../../markdown/Markdown\"\r\nimport { DatabaseManagerContext } from \"../DatabaseManagerContext\"\r\nimport { PushNotificationModal } from \"./PushNotificationModal\"\r\n\r\nconst Container = styled.div`\r\n  margin-top: 16px;\r\n  padding: 16px;\r\n\r\n  background: ${({ theme }) => theme.background.secondary};\r\n  border-radius: 3px;\r\n`\r\n\r\nconst Header = styled.h5`\r\n  margin: 0 0 8px;\r\n\r\n  color: ${({ theme }) => theme.header.primary};\r\n  font-size: 1em;\r\n  font-weight: 500;\r\n  line-height: 1.375;\r\n`\r\n\r\nconst Buttons = styled(ButtonRow)`\r\n  margin-top: 16px;\r\n`\r\n\r\nexport function PersistentStorageWarning() {\r\n  const modalManager = useRequiredContext(ModalManagerContext)\r\n  const databaseManager = useRequiredContext(DatabaseManagerContext)\r\n\r\n  return useObserver(() => (\r\n    <Container>\r\n      <Header>Warning</Header>\r\n      <Markdown\r\n        content={\r\n          \"Your browser did not grant permission to use persistent storage\" +\r\n          \" for this site. Data stored might be deleted by the browser when\" +\r\n          \" this permission is not granted.\"\r\n        }\r\n      />\r\n      <Buttons>\r\n        <PrimaryButton\r\n          onClick={async () => {\r\n            if (\"chrome\" in window) {\r\n              modalManager.spawn({\r\n                render: () => (\r\n                  <PushNotificationModal databaseManager={databaseManager} />\r\n                ),\r\n              })\r\n            } else {\r\n              await databaseManager.requestPersistence()\r\n            }\r\n          }}\r\n        >\r\n          Request permission\r\n        </PrimaryButton>\r\n        <SecondaryButton\r\n          onClick={() => {\r\n            databaseManager.persistenceMessageDismissed = true\r\n          }}\r\n        >\r\n          Dismiss\r\n        </SecondaryButton>\r\n      </Buttons>\r\n    </Container>\r\n  ))\r\n}\r\n","export const downloadBlob = (blob: Blob, name: string) => {\r\n  const url = URL.createObjectURL(blob)\r\n\r\n  const anchor = document.createElement(\"a\")\r\n  document.body.append(anchor)\r\n\r\n  anchor.href = url\r\n  anchor.download = name\r\n\r\n  anchor.click()\r\n\r\n  anchor.remove()\r\n  URL.revokeObjectURL(url)\r\n}\r\n","/* eslint-disable no-await-in-loop */\r\n\r\nimport { observable, runInAction } from \"mobx\"\r\nimport { downloadBlob } from \"../../../common/dom/downloadBlob\"\r\nimport { toSnakeCase } from \"../../../common/object/toSnakeCase\"\r\nimport type { EditorManagerLike } from \"../../editor/EditorManager\"\r\nimport { messageOf } from \"../../message/helpers/messageOf\"\r\nimport type { MessageData } from \"../../message/state/data/MessageData\"\r\nimport type { DatabaseManager } from \"../DatabaseManager\"\r\nimport type { Backup } from \"./types/Backup\"\r\nimport type { BackupData } from \"./types/BackupData\"\r\nimport type { ExportData } from \"./types/ExportData\"\r\n\r\nexport class BackupManager {\r\n  private readonly databaseManager: DatabaseManager\r\n  private readonly editorManager: EditorManagerLike\r\n\r\n  @observable backups: BackupData[] = []\r\n\r\n  constructor(\r\n    databaseManager: DatabaseManager,\r\n    editorManager: EditorManagerLike,\r\n  ) {\r\n    this.databaseManager = databaseManager\r\n    this.editorManager = editorManager\r\n\r\n    databaseManager.initialized\r\n      .then(async () => {\r\n        await this.loadBackupList()\r\n      })\r\n      .catch(() => {})\r\n  }\r\n\r\n  private async loadBackupList() {\r\n    const backups: BackupData[] = []\r\n\r\n    let cursor = await this.databaseManager.database\r\n      .transaction(\"backup\")\r\n      .objectStore(\"backup\")\r\n      .index(\"name\")\r\n      .openKeyCursor()\r\n\r\n    while (cursor) {\r\n      backups.push({\r\n        id: cursor.primaryKey,\r\n        name: cursor.key,\r\n      })\r\n\r\n      cursor = await cursor.continue()\r\n    }\r\n\r\n    runInAction(() => {\r\n      this.backups = backups\r\n    })\r\n  }\r\n\r\n  private async getId(name: string) {\r\n    return this.databaseManager.database\r\n      .transaction(\"backup\")\r\n      .objectStore(\"backup\")\r\n      .index(\"name\")\r\n      .getKey(name)\r\n  }\r\n\r\n  async loadBackup(name: string) {\r\n    const backup = await this.databaseManager.database\r\n      .transaction(\"backup\")\r\n      .objectStore(\"backup\")\r\n      .index(\"name\")\r\n      .get(name)\r\n\r\n    if (!backup) return\r\n\r\n    this.editorManager.set(\r\n      \"messages\",\r\n      backup.messages.map(({ data, ...message }) => ({\r\n        ...messageOf(data),\r\n        ...message,\r\n      })),\r\n    )\r\n    this.editorManager.set(\"targets\", backup.targets)\r\n    for (const target of this.editorManager.targets) {\r\n      target.fetch().catch(() => {})\r\n    }\r\n  }\r\n\r\n  async saveBackup(backup: string | Backup) {\r\n    if (typeof backup === \"string\") {\r\n      const id = await this.getId(backup)\r\n\r\n      backup = {\r\n        id,\r\n        name: backup,\r\n        messages: this.editorManager.messages.map(message => ({\r\n          data: {\r\n            ...message.data,\r\n            files: undefined,\r\n          },\r\n          reference: message.reference,\r\n        })),\r\n        targets: this.editorManager.targets.map(target => ({\r\n          url: target.url,\r\n        })),\r\n      }\r\n    } else {\r\n      backup = {\r\n        ...backup,\r\n        id: await this.getId(backup.name),\r\n      }\r\n    }\r\n\r\n    if (!backup.id) delete backup.id\r\n\r\n    await this.databaseManager.database\r\n      .transaction(\"backup\", \"readwrite\")\r\n      .objectStore(\"backup\")\r\n      .put(backup)\r\n\r\n    await this.loadBackupList()\r\n  }\r\n\r\n  async deleteBackup(name: string) {\r\n    const id = await this.getId(name)\r\n    if (!id) return\r\n\r\n    await this.databaseManager.database\r\n      .transaction(\"backup\", \"readwrite\")\r\n      .objectStore(\"backup\")\r\n      .delete(id)\r\n\r\n    await this.loadBackupList()\r\n  }\r\n\r\n  async exportBackup(name: string) {\r\n    const backup = await this.databaseManager.database\r\n      .transaction(\"backup\")\r\n      .objectStore(\"backup\")\r\n      .index(\"name\")\r\n      .get(name)\r\n\r\n    if (!backup) return\r\n\r\n    const backupData: ExportData = {\r\n      version: 7,\r\n      // eslint-disable-next-line @typescript-eslint/no-unused-vars\r\n      backups: [backup].map(({ id, ...backup }) => backup),\r\n    }\r\n\r\n    const blob = new Blob([JSON.stringify(backupData, undefined, 2), \"\\n\"], {\r\n      type: \"application/json\",\r\n    })\r\n\r\n    downloadBlob(blob, `${name}.json`)\r\n  }\r\n\r\n  async exportAll() {\r\n    const backups: Backup[] = []\r\n\r\n    let cursor = await this.databaseManager.database\r\n      .transaction(\"backup\")\r\n      .objectStore(\"backup\")\r\n      .openCursor()\r\n\r\n    while (cursor) {\r\n      backups.push({\r\n        ...cursor.value,\r\n        id: undefined,\r\n      })\r\n\r\n      cursor = await cursor.continue()\r\n    }\r\n\r\n    const backupData: ExportData = {\r\n      version: 7,\r\n      backups,\r\n    }\r\n\r\n    const blob = new Blob([JSON.stringify(backupData, undefined, 2), \"\\n\"], {\r\n      type: \"application/json\",\r\n    })\r\n\r\n    downloadBlob(blob, \"backups.json\")\r\n  }\r\n\r\n  private async getSafeBackupName(name: string) {\r\n    if (!(await this.getId(name))) {\r\n      return name\r\n    }\r\n\r\n    for (let number = 1; true; number++) {\r\n      const proposedName = `${name} (${number})`\r\n\r\n      if (!(await this.getId(proposedName))) {\r\n        return proposedName\r\n      }\r\n    }\r\n  }\r\n\r\n  async importBackups(blob: Blob) {\r\n    let exportData = JSON.parse(await blob.text()) as ExportData\r\n\r\n    switch (exportData.version) {\r\n      case 1:\r\n      case 2: {\r\n        exportData = {\r\n          version: 3,\r\n          backups: [\r\n            {\r\n              name: exportData.name,\r\n              message: toSnakeCase(exportData.message) as MessageData,\r\n            },\r\n          ],\r\n        }\r\n      }\r\n      // falls through\r\n      case 3: {\r\n        exportData = {\r\n          version: 4,\r\n          backups: exportData.backups.map(({ message, ...backup }) => ({\r\n            ...backup,\r\n            messages: [message],\r\n          })),\r\n        }\r\n      }\r\n      // falls through\r\n      case 4:\r\n        exportData = {\r\n          version: 5,\r\n          backups: exportData.backups.map(({ webhookUrl, ...backup }) => ({\r\n            ...backup,\r\n            target: {\r\n              url: webhookUrl,\r\n            },\r\n          })),\r\n        }\r\n      // falls through\r\n      case 5:\r\n        exportData = {\r\n          version: 6,\r\n          backups: exportData.backups.map(\r\n            ({ messages, target, ...backup }) => ({\r\n              ...backup,\r\n              messages: messages.map(data => ({\r\n                data,\r\n                reference: target.message,\r\n              })),\r\n              target: {\r\n                url: target.url,\r\n              },\r\n            }),\r\n          ),\r\n        }\r\n      // falls through\r\n      case 6:\r\n        exportData = {\r\n          version: 7,\r\n          backups: exportData.backups.map(({ target, ...backup }) => ({\r\n            ...backup,\r\n            targets: [{ url: target.url ?? \"\" }],\r\n          })),\r\n        }\r\n      // falls through\r\n      case 7:\r\n        for (const backup of exportData.backups) {\r\n          await this.saveBackup({\r\n            ...backup,\r\n            name: await this.getSafeBackupName(backup.name),\r\n            id: undefined,\r\n          })\r\n        }\r\n    }\r\n  }\r\n}\r\n","import { createContext } from \"react\"\r\nimport type { BackupManager } from \"./BackupManager\"\r\n\r\nexport const BackupManagerContext = createContext<BackupManager | null>(null)\r\n\r\nBackupManagerContext.displayName = \"BackupManagerContext\"\r\n\r\nexport const BackupManagerProvider = BackupManagerContext.Provider\r\n","import { useObserver } from \"mobx-react-lite\"\r\nimport React, { useState } from \"react\"\r\nimport { PrimaryButton } from \"../../../../common/input/button/PrimaryButton\"\r\nimport { InputField } from \"../../../../common/input/text/InputField\"\r\nimport { useRequiredContext } from \"../../../../common/state/useRequiredContext\"\r\nimport { BackupManagerContext } from \"../BackupManagerContext\"\r\n\r\nexport function BackupCreationControls() {\r\n  const backupManager = useRequiredContext(BackupManagerContext)\r\n\r\n  const [backupName, setBackupName] = useState(\"\")\r\n\r\n  return useObserver(() => (\r\n    <InputField\r\n      id=\"backup-name\"\r\n      value={backupName}\r\n      onChange={setBackupName}\r\n      label=\"Backup name\"\r\n    >\r\n      <PrimaryButton\r\n        disabled={backupName.length === 0}\r\n        onClick={async () => {\r\n          await backupManager.saveBackup(backupName.trim())\r\n          setBackupName(\"\")\r\n        }}\r\n      >\r\n        {backupManager.backups.some(backup => backup.name === backupName.trim())\r\n          ? \"Overwrite\"\r\n          : \"Save\"}\r\n      </PrimaryButton>\r\n    </InputField>\r\n  ))\r\n}\r\n","import React from \"react\"\r\n\r\nexport const save = (\r\n  <svg width=\"16\" height=\"16\" viewBox=\"0 0 16 16\" fill=\"none\">\r\n    <path\r\n      d=\"M11 15V9H5V15M5 1L4.99999 5H10M13.6667 15H2.33333C1.97971 15 1.64057 14.8595 1.39052 14.6095C1.14048 14.3594 1 14.0203 1 13.6667V2.33333C1 1.97971 1.14048 1.64057 1.39052 1.39052C1.64057 1.14048 1.97971 1 2.33333 1H11.6667L15 4.33333V13.6667C15 14.0203 14.8595 14.3594 14.6095 14.6095C14.3594 14.8595 14.0203 15 13.6667 15Z\"\r\n      stroke=\"currentColor\"\r\n      strokeWidth=\"2\"\r\n      strokeLinecap=\"round\"\r\n      strokeLinejoin=\"round\"\r\n    />\r\n  </svg>\r\n)\r\n","import React from \"react\"\r\n\r\nexport const trash = (\r\n  <svg width=\"16\" height=\"16\" viewBox=\"0 0 16 16\" fill=\"none\">\r\n    <path\r\n      d=\"M1 4L2.99999 3.99998M2.99999 3.99998V13.5C2.99999 14.3284 3.67156 15 4.49999 15L11.5 15C12.3284 15 13 14.3284 13 13.5V4M2.99999 3.99998H5.33333M13 4H15M13 4L10.6667 3.99998M5.33333 3.99998V2.5C5.33333 1.67157 6.00491 1 6.83333 1H9.16667C9.99509 1 10.6667 1.67157 10.6667 2.5V3.99998M5.33333 3.99998H10.6667\"\r\n      stroke=\"currentColor\"\r\n      strokeWidth=\"2\"\r\n      strokeLinecap=\"round\"\r\n      strokeLinejoin=\"round\"\r\n    />\r\n  </svg>\r\n)\r\n","import React from \"react\"\r\n\r\nexport const upload = (\r\n  <svg width=\"16\" height=\"16\" viewBox=\"0 0 16 16\" fill=\"none\">\r\n    <path\r\n      d=\"M14 10V12.6667C14 13.0203 13.8595 13.3594 13.6095 13.6095C13.3594 13.8595 13.0203 14 12.6667 14H3.33333C2.97971 14 2.64057 13.8595 2.39052 13.6095C2.14048 13.3594 2 13.0203 2 12.6667V10M4.66667 5.33333L8 2M8 2L11.3333 5.33333M8 2V10\"\r\n      stroke=\"currentColor\"\r\n      strokeWidth=\"2\"\r\n      strokeLinecap=\"round\"\r\n      strokeLinejoin=\"round\"\r\n    />\r\n  </svg>\r\n)\r\n","import { useObserver } from \"mobx-react-lite\"\r\nimport React from \"react\"\r\nimport { PrimaryButton } from \"../../../../common/input/button/PrimaryButton\"\r\nimport { SecondaryButton } from \"../../../../common/input/button/SecondaryButton\"\r\nimport { ModalAction } from \"../../../../common/modal/layout/ModalAction\"\r\nimport { ModalBody } from \"../../../../common/modal/layout/ModalBody\"\r\nimport { ModalContainer } from \"../../../../common/modal/layout/ModalContainer\"\r\nimport { ModalFooter } from \"../../../../common/modal/layout/ModalFooter\"\r\nimport { ModalHeader } from \"../../../../common/modal/layout/ModalHeader\"\r\nimport { ModalTitle } from \"../../../../common/modal/layout/ModalTitle\"\r\nimport { ModalContext } from \"../../../../common/modal/ModalContext\"\r\nimport { useRequiredContext } from \"../../../../common/state/useRequiredContext\"\r\nimport { remove } from \"../../../../icons/remove\"\r\nimport { Markdown } from \"../../../markdown/Markdown\"\r\nimport type { BackupManager } from \"../BackupManager\"\r\nimport type { BackupData } from \"../types/BackupData\"\r\n\r\nexport type DeletionConfirmationModalProps = {\r\n  backupManager: BackupManager\r\n  backup: BackupData\r\n}\r\n\r\nexport function DeletionConfirmationModal(\r\n  props: DeletionConfirmationModalProps,\r\n) {\r\n  const { backupManager, backup } = props\r\n\r\n  const modal = useRequiredContext(ModalContext)\r\n\r\n  return useObserver(() => (\r\n    <ModalContainer>\r\n      <ModalHeader>\r\n        <ModalTitle>Delete Backup</ModalTitle>\r\n        <ModalAction\r\n          icon={remove}\r\n          label=\"Close\"\r\n          onClick={() => modal.dismiss()}\r\n        />\r\n      </ModalHeader>\r\n      <ModalBody>\r\n        <Markdown\r\n          content={\r\n            `Are you sure you want to delete \"${backup.name}\"? This action` +\r\n            \" cannot be undone.\"\r\n          }\r\n        />\r\n      </ModalBody>\r\n      <ModalFooter>\r\n        <SecondaryButton onClick={() => modal.dismiss()}>\r\n          Cancel\r\n        </SecondaryButton>\r\n        <PrimaryButton\r\n          onClick={async () => {\r\n            await backupManager.deleteBackup(backup.name)\r\n            modal.dismiss()\r\n          }}\r\n        >\r\n          Delete\r\n        </PrimaryButton>\r\n      </ModalFooter>\r\n    </ModalContainer>\r\n  ))\r\n}\r\n","import { useObserver } from \"mobx-react-lite\"\r\nimport { ellipsis } from \"polished\"\r\nimport React from \"react\"\r\nimport styled from \"styled-components\"\r\nimport { Button } from \"../../../../common/input/button/Button\"\r\nimport { ActionButtons } from \"../../../../common/layout/ActionButtons\"\r\nimport { ModalManagerContext } from \"../../../../common/modal/ModalManagerContext\"\r\nimport { useRequiredContext } from \"../../../../common/state/useRequiredContext\"\r\nimport { copy } from \"../../../../icons/copy\"\r\nimport { save } from \"../../../../icons/save\"\r\nimport { trash } from \"../../../../icons/trash\"\r\nimport { upload } from \"../../../../icons/upload\"\r\nimport { BackupManagerContext } from \"../BackupManagerContext\"\r\nimport type { BackupData } from \"../types/BackupData\"\r\nimport { DeletionConfirmationModal } from \"./DeletionConfirmationModal\"\r\n\r\nconst Container = styled.li`\r\n  height: 48px;\r\n\r\n  display: flex;\r\n  align-items: center;\r\n\r\n  list-style: none;\r\n\r\n  border: 0 solid ${({ theme }) => theme.backgroundModifier.accent};\r\n\r\n  & + & {\r\n    border-top-width: 1px;\r\n  }\r\n\r\n  & > ${Button} {\r\n    margin: 0;\r\n  }\r\n`\r\n\r\nconst BackupName = styled.div`\r\n  ${ellipsis()};\r\n\r\n  flex: 1;\r\n  font-weight: 500;\r\n`\r\n\r\nexport type BackupItemProps = {\r\n  backup: BackupData\r\n}\r\n\r\nexport function BackupItem(props: BackupItemProps) {\r\n  const { backup } = props\r\n\r\n  const modalManager = useRequiredContext(ModalManagerContext)\r\n  const backupManager = useRequiredContext(BackupManagerContext)\r\n\r\n  return useObserver(() => (\r\n    <Container>\r\n      <BackupName>{backup.name}</BackupName>\r\n      <ActionButtons\r\n        actions={[\r\n          {\r\n            icon: upload,\r\n            label: \"Load\",\r\n            handler: async () => backupManager.loadBackup(backup.name),\r\n          },\r\n          {\r\n            icon: save,\r\n            label: \"Export\",\r\n            handler: async () => backupManager.exportBackup(backup.name),\r\n            overflow: true,\r\n          },\r\n          {\r\n            icon: copy,\r\n            label: \"Overwrite\",\r\n            handler: async () => backupManager.saveBackup(backup.name),\r\n            overflow: true,\r\n          },\r\n          {\r\n            icon: trash,\r\n            label: \"Delete\",\r\n            handler: () =>\r\n              modalManager.spawn({\r\n                render: () => (\r\n                  <DeletionConfirmationModal\r\n                    backupManager={backupManager}\r\n                    backup={backup}\r\n                  />\r\n                ),\r\n              }),\r\n            overflow: true,\r\n          },\r\n        ]}\r\n      />\r\n    </Container>\r\n  ))\r\n}\r\n","import { useObserver } from \"mobx-react-lite\"\r\nimport React, { useState } from \"react\"\r\nimport styled from \"styled-components\"\r\nimport { InputField } from \"../../../../common/input/text/InputField\"\r\nimport { useRequiredContext } from \"../../../../common/state/useRequiredContext\"\r\nimport { Markdown } from \"../../../markdown/Markdown\"\r\nimport { BackupManagerContext } from \"../BackupManagerContext\"\r\nimport { BackupItem } from \"./BackupItem\"\r\n\r\nconst Container = styled.ul`\r\n  padding: 0;\r\n  margin: 0;\r\n\r\n  max-height: 420px;\r\n  overflow-x: hidden;\r\n`\r\n\r\nexport function BackupList() {\r\n  const backupManager = useRequiredContext(BackupManagerContext)\r\n\r\n  const [search, setSearch] = useState(\"\")\r\n\r\n  return useObserver(() =>\r\n    backupManager.backups.length > 0 ? (\r\n      <>\r\n        <InputField\r\n          id=\"backups-search\"\r\n          label=\"Search Backups\"\r\n          value={search}\r\n          onChange={setSearch}\r\n        />\r\n        <Container>\r\n          {backupManager.backups\r\n            .filter(backup =>\r\n              backup.name\r\n                .toLocaleLowerCase()\r\n                .includes(search.toLocaleLowerCase()),\r\n            )\r\n            .map(backup => (\r\n              <BackupItem key={backup.id} backup={backup} />\r\n            ))}\r\n        </Container>\r\n      </>\r\n    ) : (\r\n      <Markdown\r\n        content={\r\n          \"You haven't made any backups yet.\" +\r\n          \" Enter a name below and click on the Save button to make one.\"\r\n        }\r\n      />\r\n    ),\r\n  )\r\n}\r\n","import { useObserver } from \"mobx-react-lite\"\r\nimport React, { useRef } from \"react\"\r\nimport { PrimaryButton } from \"../../../../common/input/button/PrimaryButton\"\r\nimport { SecondaryButton } from \"../../../../common/input/button/SecondaryButton\"\r\nimport { ModalAction } from \"../../../../common/modal/layout/ModalAction\"\r\nimport { ModalBody } from \"../../../../common/modal/layout/ModalBody\"\r\nimport { ModalContainer } from \"../../../../common/modal/layout/ModalContainer\"\r\nimport { ModalFooter } from \"../../../../common/modal/layout/ModalFooter\"\r\nimport { ModalHeader } from \"../../../../common/modal/layout/ModalHeader\"\r\nimport { ModalTitle } from \"../../../../common/modal/layout/ModalTitle\"\r\nimport { ModalContext } from \"../../../../common/modal/ModalContext\"\r\nimport { useLazyValue } from \"../../../../common/state/useLazyValue\"\r\nimport { useRequiredContext } from \"../../../../common/state/useRequiredContext\"\r\nimport { remove } from \"../../../../icons/remove\"\r\nimport type { EditorManagerLike } from \"../../../editor/EditorManager\"\r\nimport { DatabaseManager } from \"../../DatabaseManager\"\r\nimport { DatabaseManagerProvider } from \"../../DatabaseManagerContext\"\r\nimport { PersistentStorageWarning } from \"../../persist/PersistentStorageWarning\"\r\nimport { BackupManager } from \"../BackupManager\"\r\nimport { BackupManagerProvider } from \"../BackupManagerContext\"\r\nimport { BackupCreationControls } from \"./BackupCreationControls\"\r\nimport { BackupList } from \"./BackupList\"\r\n\r\nexport type BackupsModalProps = {\r\n  editorManager: EditorManagerLike\r\n}\r\n\r\nexport function BackupsModal(props: BackupsModalProps) {\r\n  const { editorManager } = props\r\n\r\n  const databaseManager = useLazyValue(() => new DatabaseManager())\r\n  const backupManager = useLazyValue(\r\n    () => new BackupManager(databaseManager, editorManager),\r\n  )\r\n\r\n  const modal = useRequiredContext(ModalContext)\r\n\r\n  const fileInputRef = useRef<HTMLInputElement>(null)\r\n\r\n  return useObserver(() => (\r\n    <DatabaseManagerProvider value={databaseManager}>\r\n      <BackupManagerProvider value={backupManager}>\r\n        <ModalContainer>\r\n          <input\r\n            ref={fileInputRef}\r\n            type=\"file\"\r\n            style={{ display: \"none\" }}\r\n            onChange={async event => {\r\n              const file = event.target.files?.item(0)?.slice()\r\n              event.target.files = null\r\n              if (file) {\r\n                await backupManager.importBackups(file)\r\n              }\r\n            }}\r\n          />\r\n          <ModalHeader>\r\n            <ModalTitle>Backups</ModalTitle>\r\n            <ModalAction\r\n              icon={remove}\r\n              label=\"Close\"\r\n              onClick={() => modal.dismiss()}\r\n            />\r\n          </ModalHeader>\r\n          {databaseManager.shouldShowPersistenceWarning && (\r\n            <ModalBody>\r\n              <PersistentStorageWarning />\r\n            </ModalBody>\r\n          )}\r\n          <ModalBody>\r\n            <BackupList />\r\n          </ModalBody>\r\n          <ModalBody>\r\n            <BackupCreationControls />\r\n          </ModalBody>\r\n          <ModalFooter>\r\n            <SecondaryButton onClick={async () => backupManager.exportAll()}>\r\n              Export All\r\n            </SecondaryButton>\r\n            <SecondaryButton onClick={() => fileInputRef.current?.click()}>\r\n              Import\r\n            </SecondaryButton>\r\n            <PrimaryButton onClick={() => modal.dismiss()}>Close</PrimaryButton>\r\n          </ModalFooter>\r\n        </ModalContainer>\r\n      </BackupManagerProvider>\r\n    </DatabaseManagerProvider>\r\n  ))\r\n}\r\n"],"sourceRoot":""}